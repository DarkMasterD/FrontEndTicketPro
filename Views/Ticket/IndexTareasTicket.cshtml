@model FrontEndTicketPro.Models.tareaTicketViewModel
@{
    var tareas = Model;
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<style>
    body {
        background-color: #e9ecef;
    }

    .header-tarea {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
    }

        .header-tarea h1 {
            margin: 0;
            font-size: 2rem;
            line-height: 1;
        }

    .codigo-ticket {
        font-size: 1.75rem;
        font-weight: 700;
        color: #333;
        margin-top: 5px;
    }

    .input-group {
        border-radius: 0.5rem;
        overflow: hidden;
        border: 1px solid #ced4da;
    }

        .input-group .form-control {
            border: none;
            box-shadow: none;
        }

    .input-group-text {
        border: none;
        background-color: #fff;
    }

    table {
        border-radius: 0.5rem;
        border-collapse: separate !important;
        border-spacing: 0;
        margin-bottom: 1rem;
        border: 1px solid #dee2e6;
        width: 100%;
        background-color: white;
    }

    thead tr {
        background: none !important;
        border-bottom: 1px solid black !important;
    }

    thead th {
        border: none !important;
        font-weight: 600;
        color: #212529;
    }

    tbody td {
        border-top: none !important;
        border-bottom: none !important;
    }

    tbody tr:hover {
        background-color: #f8f9fa;
    }

    .btn-agregar {
        background-color: #198754;
        border-color: #198754;
        color: white;
    }

        .btn-agregar:hover {
            background-color: #157347;
            border-color: #146c43;
            color: white;
        }

    .btn-regresar {
        border: 1px solid black;
        background-color: white;
        color: black;
        padding: 0.75rem 2.5rem;
        font-size: 1.25rem;
        border-radius: 0.375rem;
        margin: 1.5rem auto 0 auto;
        display: block;
        cursor: pointer;
        transition: background-color 0.3s;
        text-align: center;
    }

        .btn-regresar:hover {
            background-color: #f8f9fa;
        }

    .ventana-tarea {
        border-radius: 0.5rem;
        padding: 2rem;
        box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.1);
        background-color: #fff;
    }

    .estado-en-progreso {
        background-color: #0d6efd;
        color: white;
        font-weight: bold;
        border-radius: 0.375rem;
        padding: 0.25rem 0.5rem;
        display: inline-block;
    }

    .estado-asignado {
        background-color: #ffc107;
        color: white;
        font-weight: bold;
        border-radius: 0.375rem;
        padding: 0.25rem 0.5rem;
        display: inline-block;
    }

    .estado-finalizado {
        background-color: #198754;
        color: white;
        font-weight: bold;
        border-radius: 0.375rem;
        padding: 0.25rem 0.5rem;
        display: inline-block;
    }

    .estado-descartado {
        background-color: #dc3545;
        color: white;
        font-weight: bold;
        border-radius: 0.375rem;
        padding: 0.25rem 0.5rem;
        display: inline-block;
    }

    .estado-desconocido {
        background-color: #dc3545;
        color: white;
        font-weight: bold;
        border-radius: 0.375rem;
        padding: 0.25rem 0.5rem;
        display: inline-block;
    }
</style>

<div class="container mt-5">
    <div class="ventana-tarea">
        <div class="header-tarea">
            <h1 class="display-5">Tareas del Ticket:</h1>
            <span class="codigo-ticket"> #@tareas.Codigo</span>
        </div>

        <div class="mb-4">
            <div class="col-md-6 mb-2">
                <label class="form-label fw-bold">Título del ticket:</label>
                <p class="form-control-plaintext">@tareas.Titulo</p>
            </div>
            <div class="col-md-6 mb-2">
                <label class="form-label fw-bold">Descripción del ticket:</label>
                <p class="form-control-plaintext">@tareas.Descripcion</p>
            </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-4">
            <div class="input-group w-50">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
                <input type="text" class="form-control" placeholder="Buscar tarea...">
            </div>
            <button class="btn btn-agregar col-4" data-bs-toggle="modal" data-bs-target="#modalAgregarTarea">Agregar tarea</button>
        </div>

        <div>
            <table class="table">
                <thead>
                    <tr>
                        <th>Usuario asignado</th>
                        <th>Título</th>
                        <th>Estado</th>
                        <th>Fecha</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var tarea in tareas.Tareas)
                    {
                        var estadoNormalizado = tarea.Estado?.Trim().ToLowerInvariant();
                        var estadoClase = estadoNormalizado switch
                        {
                            "en progreso" => "estado-en-progreso",
                            "asignada" => "estado-asignado",
                            "finalizada" => "estado-finalizado",
                            "descartado" => "estado-descartado",
                            _ => "estado-desconocido" // Para estados que no coincidan
                        };

                        <tr>
                            <td>@tarea.UsuarioAsignado</td>
                            <td>@tarea.Nombre</td>
                            <td><span class="@estadoClase">@tarea.Estado</span></td>
                            <td>@tarea.FechaInicio.ToShortDateString()</td>
                            <td>
                                <button class="btn btn-sm btn-outline-secondary">
                                    <i class="bi bi-pencil-square"></i>
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>

            <button class="btn btn-regresar">Regresar</button>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="modalAgregarTarea" tabindex="-1" aria-labelledby="modalAgregarTareaLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="AgregarNuevaTarea">
                <input type="hidden" name="id_ticket" value="@ViewBag.id_ticket" />

                <div class="modal-header">
                    <h5 class="modal-title" id="modalAgregarTareaLabel">Agregar tarea al ticket #@tareas.Codigo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>

                <div class="modal-body">
                    <div class="mb-3">
                        <label for="titulo" class="form-label">Título de la tarea</label>
                        <input type="text" class="form-control" id="titulo" name="titulo" required placeholder="Ingrese el título de la tarea" />
                    </div>

                    <div class="form-group mb-3">
                        <label for="estado">Estado</label>
                        <select class="form-control" id="estado" name="Estado" required>
                            <option value="Asignada">Asignada</option>
                            <option value="En progreso">En progreso</option>
                            <option value="Finalizada">Finalizada</option>
                            <option value="Descartado">Descartado</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="tecnico" class="form-label">Seleccionar técnico</label>
                        <!-- Aquí puedes llenar el combobox con los técnicos de la base de datos -->
                        <select class="form-select" id="IdTecnicoSeleccionado" asp-for="IdTecnicoSeleccionado" asp-items="Model.Tecnicos">
                            <option disabled selected value="">Seleccione un técnico</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="descripcion" class="form-label">Descripción de la tarea</label>
                        <textarea class="form-control" id="descripcion" name="descripcion" rows="3" required placeholder="Ingrese la descripción de la tarea"></textarea>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="submit" class="btn btn-success">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
      const form = document.querySelector('#AgregarNuevaTarea');

          form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const idTicket = form.querySelector('input[name="id_ticket"]').value;
            const titulo = form.querySelector('#titulo').value.trim();
            const estado = form.querySelector('#estado').value;
            const tecnicoSelect = form.querySelector('#IdTecnicoSeleccionado');
            const tecnico = tecnicoSelect ? tecnicoSelect.value : null;
            const descripcion = form.querySelector('#descripcion').value.trim();

            if (!titulo || !estado || !tecnico || !descripcion) {
              alert('Por favor, complete todos los campos.');
              return;
            }

            const tareaData = {
              IdTicket: parseInt(idTicket),
              Nombre: titulo,
              Estado: estado,
              IdUsuarioInterno: parseInt(tecnico),
              Descripcion: descripcion
            };

            try {
                const response = await fetch('https://localhost:7141/api/ticket/AgregarNuevaTarea', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify(tareaData)
              });

              if (!response.ok) {
                throw new Error('Error al guardar la tarea');
              }

              const result = await response.json();

              alert(result.mensaje || 'Tarea agregada correctamente');

              const modal = bootstrap.Modal.getInstance(document.getElementById('modalAgregarTarea'));
              modal.hide();

              form.reset();

                // Recargar la página
                window.location.reload();

            } catch (error) {
              alert('No se pudo guardar la tarea: ' + error.message);
            }
          });
        });
    </script>
