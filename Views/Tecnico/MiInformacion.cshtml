@model FrontEndTicketPro.Models.TecnicoPerfilViewModel
@{
    ViewData["Title"] = "Datos personales - Técnico";
}

<div class="container mt-4 p-4 bg-white rounded shadow-sm">
    <h3 class="fw-bold text-center mb-4">👤 Datos personales / Editar</h3>

    <input type="hidden" id="id_usuario" value="@Context.Session.GetInt32("id_usuario")" />

    <div class="row">
        <div class="col-md-6">
            <label class="form-label">👤 Nombre</label>
            <input class="form-control" value="@Model.Nombre" readonly />

            <label class="form-label mt-3">📍 Dirección</label>
            <input class="form-control" value="@Model.Direccion" readonly />

            <button class="btn btn-primary mt-4 w-100" data-bs-toggle="modal" data-bs-target="#modalContrasenia">
                🔒 Cambiar contraseña
            </button>
        </div>

        <div class="col-md-6">
            <label class="form-label">👤 Usuario</label>
            <input class="form-control" value="@Model.Usuario" readonly />

            <label class="form-label mt-3">📅 Fecha de registro:</label>
            <input class="form-control" value="@Model.FechaRegistro.ToString("dd/MMM/yyyy")" readonly />

            <button class="btn btn-dark mt-4 w-100" data-bs-toggle="modal" data-bs-target="#modalContacto">
                Ver información de contacto
            </button>
        </div>
    </div>

    <div class="text-center mt-5">
        <a asp-action="Inicio" asp-controller="Tecnico" class="btn btn-outline-dark">Cancelar</a>
    </div>
</div>

<!-- Modal para cambiar contraseña -->
<div class="modal fade" id="modalContrasenia" tabindex="-1" aria-labelledby="modalContraseniaLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">🔐 Cambiar la contraseña</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formCambiarContrasenia">
                    <div class="mb-3">
                        <label class="form-label">Contraseña actual</label>
                        <input type="password" class="form-control" id="actual" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Nueva contraseña</label>
                        <input type="password" class="form-control" id="nueva" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Confirmar la contraseña</label>
                        <input type="password" class="form-control" id="confirmar" required />
                    </div>
                    <div class="d-flex justify-content-end">
                        <button type="submit" class="btn btn-success">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal para ver información de contacto -->
<div class="modal fade" id="modalContacto" tabindex="-1" aria-labelledby="modalContactoLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">📞 Información de contacto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>📧 Correo:</strong> <span id="correoContacto">Cargando...</span></p>
                <p><strong>📱 Teléfono:</strong> <span id="telefonoContacto">Cargando...</span></p>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.getElementById("formCambiarContrasenia").addEventListener("submit", async function (e) {
            e.preventDefault();

            const actual = document.getElementById("actual").value;
            const nueva = document.getElementById("nueva").value;
            const confirmar = document.getElementById("confirmar").value;
            const idUsuario = document.getElementById("id_usuario").value;

            if (nueva !== confirmar) {
                alert("Las contraseñas no coinciden");
                return;
            }

            const payload = {
                idUsuario: parseInt(idUsuario),
                actual: actual,
                nueva: nueva
            };

            try {
                const response = await fetch("https://localhost:7141/api/usuario/cambiar-contrasenia", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.text();
                alert(result);
                if (response.ok) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById("modalContrasenia"));
                    modal.hide();
                    setTimeout(() => window.location.reload(), 500);
                }
            } catch (err) {
                alert("Error al intentar cambiar la contraseña.");
                console.error(err);
            }
        });

        document.querySelector('[data-bs-target="#modalContacto"]').addEventListener("click", async function () {
            const id = document.getElementById("id_usuario").value;
            console.log("ID técnico:", id);
            try {
                const response = await fetch(`https://localhost:7141/api/usuario/contacto/${id}`);
                if (!response.ok) throw new Error("Error obteniendo contacto");
                const contacto = await response.json();
                document.getElementById("correoContacto").innerText = contacto.email || "Sin registro";
                document.getElementById("telefonoContacto").innerText = contacto.telefono || "Sin registro";
            } catch (err) {
                alert("Error al obtener información de contacto");
                console.error(err);
            }
        });
    </script>
}